# Bugfix Requirements Document

## Introduction

Парсеры недвижимости (Avito, Cian, Yandex Realty и другие) постоянно выдают ошибки при извлечении данных из HTML. Основные проблемы: отсутствие проверок на None/пустые значения, прямой доступ к атрибутам без валидации, слабая обработка изменений в HTML структуре, недостаточное логирование и отсутствие fallback механизмов. Это приводит к падению парсеров и потере данных даже когда большая часть элементов могла быть успешно обработана.

## Bug Analysis

### Current Behavior (Defect)

1.1 WHEN парсер обращается к `item["data-item-id"]` и атрибут отсутствует THEN система выбрасывает KeyError и прерывает обработку всех последующих элементов

1.2 WHEN парсер обращается к `price_elem["content"]` и элемент price_elem равен None THEN система выбрасывает TypeError и прерывает обработку всех последующих элементов

1.3 WHEN парсер обращается к `link_elem["href"]` и атрибут href отсутствует или пустой THEN система создает невалидный PropertyCreate объект с пустой ссылкой

1.4 WHEN HTML структура сайта изменилась и селекторы не находят элементы THEN система молча пропускает все элементы без логирования причины

1.5 WHEN парсер пытается извлечь цену из элемента с нестандартным форматом THEN система падает с ValueError при конвертации в float

1.6 WHEN изображения загружаются через lazy loading с атрибутом data-src THEN система не извлекает URL фотографий, так как проверяет только атрибут src

1.7 WHEN парсер создает PropertyCreate с невалидными данными (например, отрицательная цена) THEN Pydantic выбрасывает ValidationError и прерывает обработку всех последующих элементов

1.8 WHEN парсинг завершается THEN система не логирует статистику (сколько элементов найдено, сколько успешно обработано, сколько пропущено)

1.9 WHEN происходит ошибка парсинга конкретного элемента THEN система логирует только общее сообщение "Error parsing item" без деталей о том, какое поле вызвало ошибку

1.10 WHEN парсер обрабатывает пустой или невалидный HTML THEN система возвращает пустой список без предупреждения о возможной проблеме

### Expected Behavior (Correct)

2.1 WHEN парсер обращается к атрибуту элемента THEN система SHALL использовать безопасный метод доступа (например, .get()) с проверкой на None

2.2 WHEN парсер не может извлечь обязательное поле (external_id, title, price, link) THEN система SHALL пропустить этот элемент, залогировать причину с деталями и продолжить обработку следующих элементов

2.3 WHEN парсер извлекает данные для создания PropertyCreate THEN система SHALL валидировать данные перед созданием объекта и обрабатывать ValidationError

2.4 WHEN HTML структура изменилась и селекторы не находят элементы THEN система SHALL логировать предупреждение с указанием селектора и количества найденных элементов

2.5 WHEN парсер извлекает цену THEN система SHALL использовать несколько стратегий извлечения (атрибут content, текст элемента, regex) с fallback механизмом

2.6 WHEN парсер извлекает URL фотографий THEN система SHALL проверять как атрибут src, так и data-src для поддержки lazy loading

2.7 WHEN парсер извлекает URL фотографий THEN система SHALL валидировать URL (проверка на пустую строку, относительный/абсолютный путь)

2.8 WHEN парсинг завершается THEN система SHALL логировать статистику: общее количество найденных элементов, успешно обработанных, пропущенных с причинами

2.9 WHEN происходит ошибка при извлечении конкретного поля THEN система SHALL логировать детальную информацию: имя поля, значение элемента, тип ошибки

2.10 WHEN парсер обрабатывает HTML и не находит ни одного элемента по основному селектору THEN система SHALL логировать предупреждение о возможном изменении структуры сайта

### Unchanged Behavior (Regression Prevention)

3.1 WHEN парсер успешно извлекает все данные из корректно структурированного HTML THEN система SHALL CONTINUE TO создавать валидные PropertyCreate объекты с теми же полями

3.2 WHEN парсер извлекает количество комнат и площадь из заголовка THEN система SHALL CONTINUE TO использовать существующие regex паттерны для извлечения

3.3 WHEN парсер извлекает локацию и описание THEN система SHALL CONTINUE TO использовать существующие методы _extract_location и _extract_description

3.4 WHEN парсер ограничивает количество фотографий до 5 THEN система SHALL CONTINUE TO применять этот лимит

3.5 WHEN парсер обрабатывает относительные URL THEN система SHALL CONTINUE TO преобразовывать их в абсолютные с использованием BASE_URL

3.6 WHEN парсер возвращает список PropertyCreate объектов THEN система SHALL CONTINUE TO возвращать список в том же формате для совместимости с вызывающим кодом

3.7 WHEN парсер использует BeautifulSoup для парсинга HTML THEN система SHALL CONTINUE TO использовать lxml парсер

3.8 WHEN парсер обрабатывает цены в разных форматах (с пробелами, запятыми) THEN система SHALL CONTINUE TO корректно конвертировать их в float
