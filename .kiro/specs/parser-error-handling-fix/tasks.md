# Список Задач для Исправления Ошибок Парсинга

- [ ] 1. Написать exploration тест для выявления условий ошибки
  - **Property 1: Fault Condition** - Небезопасный Доступ к Атрибутам HTML
  - **КРИТИЧНО**: Этот тест ДОЛЖЕН упасть на неисправленном коде - падение подтверждает существование ошибки
  - **НЕ ПЫТАЙТЕСЬ исправить тест или код когда он упадет**
  - **ПРИМЕЧАНИЕ**: Этот тест кодирует ожидаемое поведение - он будет валидировать исправление когда пройдет после реализации
  - **ЦЕЛЬ**: Выявить контрпримеры, демонстрирующие существование ошибки
  - **Подход Scoped PBT**: Для детерминированных ошибок, ограничить property конкретными падающими случаями для воспроизводимости
  - Создать тестовые HTML фрагменты с отсутствующими атрибутами, None элементами и невалидными данными
  - Тест 1.1: HTML элемент без атрибута `data-item-id` (должен упасть с KeyError)
  - Тест 1.2: HTML без элемента `[itemprop='price']` (должен упасть с TypeError при обращении к None)
  - Тест 1.3: Элемент ссылки без атрибута `href` (должен упасть с KeyError)
  - Тест 1.4: Изображения только с атрибутом `data-src` (не извлечет фотографии)
  - Тест 1.5: Элемент цены с нечисловым значением (должен упасть с ValueError)
  - Тест 1.6: Данные с отрицательной ценой (должен упасть с ValidationError от Pydantic)
  - Тест 1.7: HTML без элементов `[data-marker='item']` (вернет пустой список без предупреждения)
  - Запустить тесты на НЕИСПРАВЛЕННОМ коде в `app/parsers/avito/parser.py` метод `_parse_html` (строка 111)
  - **ОЖИДАЕМЫЙ РЕЗУЛЬТАТ**: Тесты ПАДАЮТ (это правильно - доказывает существование ошибки)
  - Документировать найденные контрпримеры для понимания первопричины
  - Отметить задачу выполненной когда тест написан, запущен и падение задокументировано
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 1.10_

- [ ] 2. Написать preservation property тесты (ДО реализации исправления)
  - **Property 2: Preservation** - Сохранение Успешного Парсинга
  - **ВАЖНО**: Следовать методологии observation-first
  - Наблюдать поведение на НЕИСПРАВЛЕННОМ коде для корректно структурированного HTML
  - Наблюдение: корректный HTML с полным набором атрибутов успешно парсится
  - Наблюдение: извлечение комнат и площади работает с существующими regex паттернами
  - Наблюдение: методы _extract_location и _extract_description работают корректно
  - Наблюдение: ограничение фотографий до 5 применяется
  - Наблюдение: относительные URL преобразуются в абсолютные
  - Написать property-based тесты, фиксирующие наблюдаемые паттерны поведения из Preservation Requirements
  - Property-based тестирование генерирует множество тестовых случаев для более сильных гарантий
  - Запустить тесты на НЕИСПРАВЛЕННОМ коде
  - **ОЖИДАЕМЫЙ РЕЗУЛЬТАТ**: Тесты ПРОХОДЯТ (подтверждает базовое поведение для сохранения)
  - Отметить задачу выполненной когда тесты написаны, запущены и проходят на неисправленном коде
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8_

- [ ] 3. Исправление ошибок парсинга

  - [ ] 3.1 Создать вспомогательные функции для безопасного доступа
    - Добавить функцию `_safe_get_attr(element, attr_name, default=None)` для безопасного извлечения атрибутов
    - Добавить функцию `_safe_get_text(element, default="")` для безопасного извлечения текста
    - Создать класс `ParsingStatistics` для сбора статистики парсинга (найдено, обработано, пропущено)
    - Опционально: добавить базовые методы в `app/parsers/base_parser.py` для переиспользования
    - _Bug_Condition: isBugCondition(input) где operation_type == "direct_attribute_access" AND attribute_name NOT IN html_element.attrs_
    - _Expected_Behavior: безопасная обработка отсутствующих атрибутов с fallback значениями_
    - _Preservation: сохранение существующих методов извлечения данных_
    - _Requirements: 2.1, 2.9_

  - [ ] 3.2 Улучшить метод _parse_html в Avito парсере
    - Файл: `app/parsers/avito/parser.py`, метод `_parse_html` (строка 111)
    - Заменить `item["data-item-id"]` на `item.get("data-item-id")` с проверкой на None
    - Заменить `price_elem["content"]` на безопасный доступ с проверкой price_elem на None
    - Заменить `link_elem["href"]` на `link_elem.get("href")` с валидацией на пустую строку
    - Добавить проверку на пустую строку после `title_elem.text.strip()`
    - Реализовать многоуровневую стратегию извлечения цены: атрибут content → текст элемента с regex → альтернативные селекторы
    - Улучшить извлечение фотографий: проверять `img.get("src") or img.get("data-src")`
    - Валидировать URL фотографий (не пустая строка, корректный формат)
    - Обернуть создание PropertyCreate в try-except для обработки ValidationError
    - Добавить детальное логирование: какое поле отсутствует, значение селектора, тип ошибки
    - Логировать предупреждение если основной селектор `[data-marker='item']` не находит элементы
    - Логировать итоговую статистику: найдено X элементов, успешно обработано Y, пропущено Z
    - _Bug_Condition: isBugCondition(input) где operation_type включает direct_attribute_access, method_call на None, nested_access, pydantic_validation_
    - _Expected_Behavior: безопасная обработка всех типов ошибок с детальным логированием и продолжением обработки_
    - _Preservation: сохранение всех существующих методов извлечения, regex паттернов, ограничений и формата возвращаемых объектов_
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8_

  - [ ] 3.3 Применить аналогичные исправления к Cian парсеру
    - Файл: `app/parsers/cian/parser.py`, метод `_parse_html` (строка 151)
    - Применить те же паттерны безопасного доступа к атрибутам
    - Реализовать fallback механизмы для извлечения критических данных
    - Добавить детальное логирование и статистику
    - Обработать ValidationError при создании PropertyCreate
    - _Bug_Condition: аналогично Avito парсеру_
    - _Expected_Behavior: аналогично Avito парсеру_
    - _Preservation: сохранение существующего поведения Cian парсера_
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10_

  - [ ] 3.4 Применить аналогичные исправления к Yandex Realty парсеру
    - Файл: `app/parsers/yandex_realty/parser.py` (если существует аналогичный метод)
    - Применить те же паттерны безопасного доступа к атрибутам
    - Реализовать fallback механизмы для извлечения критических данных
    - Добавить детальное логирование и статистику
    - Обработать ValidationError при создании PropertyCreate
    - _Bug_Condition: аналогично Avito парсеру_
    - _Expected_Behavior: аналогично Avito парсеру_
    - _Preservation: сохранение существующего поведения Yandex Realty парсера_
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10_

  - [ ] 3.5 Проверить что exploration тест теперь проходит
    - **Property 1: Expected Behavior** - Безопасная Обработка Отсутствующих Атрибутов
    - **ВАЖНО**: Перезапустить ТОТ ЖЕ тест из задачи 1 - НЕ писать новый тест
    - Тест из задачи 1 кодирует ожидаемое поведение
    - Когда этот тест проходит, это подтверждает что ожидаемое поведение выполнено
    - Запустить exploration тест из шага 1
    - **ОЖИДАЕМЫЙ РЕЗУЛЬТАТ**: Тест ПРОХОДИТ (подтверждает что ошибка исправлена)
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10_

  - [ ] 3.6 Проверить что preservation тесты все еще проходят
    - **Property 2: Preservation** - Сохранение Успешного Парсинга
    - **ВАЖНО**: Перезапустить ТЕ ЖЕ тесты из задачи 2 - НЕ писать новые тесты
    - Запустить preservation property тесты из шага 2
    - **ОЖИДАЕМЫЙ РЕЗУЛЬТАТ**: Тесты ПРОХОДЯТ (подтверждает отсутствие регрессий)
    - Подтвердить что все тесты все еще проходят после исправления (нет регрессий)
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8_

- [ ] 4. Написать unit тесты для новой функциональности
  - Тест безопасного извлечения атрибутов с отсутствующими значениями
  - Тест fallback механизма для извлечения цены (атрибут content → текст элемента → regex)
  - Тест извлечения фотографий с поддержкой lazy loading (src и data-src)
  - Тест валидации данных перед созданием PropertyCreate
  - Тест логирования статистики парсинга
  - Тест обработки пустого HTML
  - Тест детального логирования ошибок с указанием проблемного поля
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10_

- [ ] 5. Написать integration тесты
  - Тест полного цикла парсинга с реальным HTML от Avito (сохраненный snapshot)
  - Тест парсинга HTML с частично отсутствующими данными (некоторые элементы корректны, некоторые нет)
  - Тест логирования статистики после завершения парсинга
  - Тест применения исправления к другим парсерам (Cian, Yandex Realty)
  - _Requirements: 2.8, 3.1, 3.6_

- [ ] 6. Checkpoint - Убедиться что все тесты проходят
  - Убедиться что все тесты проходят, спросить пользователя если возникнут вопросы
