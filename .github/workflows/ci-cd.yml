name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # 1. Security Scan
  # ============================================================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety pip-audit

    - name: Run Bandit (security linter)
      run: |
        bandit -r app/ -ll -f json -o bandit-report.json || true
        bandit -r app/ -ll

    - name: Run Safety (dependency vulnerabilities)
      run: |
        safety check -r requirements.txt --json > safety-report.json || true
        safety check -r requirements.txt

    - name: Run Pip-Audit
      run: |
        pip-audit -r requirements.txt || true

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # ============================================================================
  # 2. Lint & Type Check
  # ============================================================================
  lint:
    name: ðŸ“ Lint & Type Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black ruff mypy

    - name: Run Black (format check)
      run: black --check app/ tests/

    - name: Run Ruff (linter)
      run: ruff check app/ tests/

    - name: Run Mypy (type check)
      run: mypy app/ --ignore-missing-imports --no-error-summary

  # ============================================================================
  # 3. Tests with Coverage
  # ============================================================================
  test:
    name: ðŸ§ª Tests & Coverage
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: rentscout
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: rentscout_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run tests with coverage
      env:
        DATABASE_URL: postgresql+asyncpg://rentscout:test_password@localhost:5432/rentscout_test
        REDIS_URL: redis://localhost:6379/0
        TESTING: true
        SENTRY_DSN: ""
      run: |
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=html --tb=short

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

    - name: Upload coverage HTML
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-html
        path: htmlcov/

  # ============================================================================
  # 4. Integration Tests
  # ============================================================================
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: rentscout
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: rentscout_integration_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run migrations
      env:
        DATABASE_URL: postgresql+asyncpg://rentscout:test_password@localhost:5432/rentscout_integration_test
      run: |
        alembic upgrade head

    - name: Run integration tests
      env:
        DATABASE_URL: postgresql+asyncpg://rentscout:test_password@localhost:5432/rentscout_integration_test
        REDIS_URL: redis://localhost:6379/0
        TESTING: true
        INTEGRATION_TESTS: true
      run: |
        pytest tests/integration/ -v --tb=short || echo "No integration tests yet"

  # ============================================================================
  # 5. Build Docker Images
  # ============================================================================
  docker-build:
    name: ðŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: [ security, lint, test ]
    if: github.event_name == 'push' || github.event_name == 'release'
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix=sha-
          type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  # ============================================================================
  # 6. Deploy to Staging
  # ============================================================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [ docker-build ]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.rentscout.dev
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add your deployment commands here (kubectl, docker-compose, etc.)
        # Example: kubectl set image deployment/rentscout rentscout=ghcr.io/${{ github.repository }}:${{ github.sha }}
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests on staging..."
        # curl -f https://staging.rentscout.dev/api/health || exit 1

  # ============================================================================
  # 7. Deploy to Production
  # ============================================================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [ docker-build ]
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'
    environment:
      name: production
      url: https://api.rentscout.dev
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        # Add your deployment commands here
        # Example: kubectl set image deployment/rentscout rentscout=ghcr.io/${{ github.repository }}:${{ github.sha }}
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests on production..."
        # curl -f https://api.rentscout.dev/api/health || exit 1
    
    - name: Notify on success
      if: success()
      run: |
        echo "âœ… Deployment to production successful!"
        # Add Slack/Telegram notification here
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Deployment to production failed!"
        # Add Slack/Telegram notification here

  # ============================================================================
  # 8. Generate Release Notes
  # ============================================================================
  release-notes:
    name: ðŸ“ Generate Release Notes
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: [ deploy-production ]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate release notes
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: commits } = await github.rest.repos.listCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha
          });
          
          const commitMessages = commits.map(c => c.commit.message.split('\n')[0]);
          console.log('Changes in this release:');
          commitMessages.forEach(msg => console.log(`- ${msg}`));
